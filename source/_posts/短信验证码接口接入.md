---
title: 短信验证码接口接入
date: 2018-06-17 21:40:00
comments: true
categories: [Java]
tags: [Java,验证码,Redis,注册]
---

本文以注册功能为例就自己在毕设项目中所接入的[云片网](https://www.yunpian.com/)短信验证码接口过程做一总结。本来毕设项目中的注册页面和登录页面的验证码部分打算直接使用免费的图片验证码就得了，后来发现果然还是短信验证码更有逼格一点，于是就尝试接入了云片网的服务（云片网看到请将广告费打到本人支付宝）。关于服务商家的选择可以参考知乎问题：[短信验证码API哪家比较好？](https://www.zhihu.com/question/36252652)

<!-- more -->

## 功能流程

注册的大概业务流程：

![mark](http://imgblog.kuranado.com/blog/180617/ijLKBFb7cC.png)

用户名、密码等都不是本文关心的部分，所以图中已略去

## 定义短信模板

在开始之前需要注册[云片网](https://www.yunpian.com/)账号，并拿到 `API_KEY`，注册好账户后，登录云片管理后台

我们知道短信验证码这种东西的内容是不能随便乱写的，在向用户发送短信验证码时需要定义好要发送的短信模板，以下为本人定义的短信模板

```
【KURANADO商城】感谢您注册KURANADO商城，您的注册验证码是:#code#，5分钟内有效，如非本人操作，请忽略此短信
```

其中`【KURANADO商城】`为短信签名，如 `【美团】`，`【淘宝】`等，`#code#` 可看做为一个变量，最终将显示为实际的验证码，模板编辑完毕后需要提交给云片网工作人员审核，审核通过后就可以使用该模板了

## 前端页面

前端页面对我来说很难写，所以干脆直接找了个模板稍微改动下就放到项目中去了，相信做过淘淘商城项目的应该对这个页面会比较熟悉：

![mark](http://imgblog.kuranado.com/blog/180617/H6jlGa1gBc.png)

“获取验证码”按钮初始处于禁用状态，重点在于手机号和验证码那两栏，当用户输入手机号后，会根据正则表达式判断手机号是否合法，若合法则“获取验证码”按钮变成可点击状态，点击后后台代码会调用接口向用户手机发送一条短信验证码，同时“获取验证码”按钮会开始 1 分钟倒计时，在此期间按钮将一直处于禁用状态。用户输入正确验证码后，点击注册按钮，会先通过 Ajax 检查用户名和手机号是否已被注册，通过后才会开始用户信息注册。

前端核心代码：

```
<div class="item" id="dphone">
    <span class="label">
        <b class="ftx04">*</b>手机号：
    </span>
    <div class="fl item-ifo">
        <input type="text" id="phone" maxlength="11" name="phone" class="text" tabindex="4" autocomplete="off" />
        <i class="i-phone">
        </i>
        <label id="phone_succeed" class="blank">
        </label>
        <label id="phone_error">
        </label>
    </div>
</div>
<div class="item" id="dcheckcode">
    <span class="label">
        <b class="ftx04">*</b>验证码：
    </span>
    <div class="fl item-ifo">
        <input type="text" id="checkcode" maxlength="6" name="checkcode" class="text" tabindex="5" autocomplete="off" style="float: left;width: 100px;" />
        <input type="button" id="yzm" value="获取验证码" disabled="disabled" style="background-color: #ccc;"/>
    </div>
</div>

<script type="text/javascript">
    $(function() {
        // 一次发送验证码后需要等待的时间
        var totalTime = 60;
        // 剩余等待时间
        var timeLeft = totalTime;
        var btn = $("#yzm");
        var phone = $("#phone");
        // 电话号码的正则表达式
        var reg = /^[1][3,4,5,7,8][0-9]{9}$/;
        phone.keyup(function() {
            if (reg.test(phone.val())) {
                btn.removeAttr("disabled");
                btn.css("background-color", "#DF3635")
            } else {
                btn.attr("disabled", true);
                btn.css("background-color", "#CCC");
            }
        });
        function timeCount() {
            timeLeft -= 1;
            if (timeLeft > 0) {
                btn.val(timeLeft + "秒后重发");
                btn.attr("disabled", true);
                btn.css("background-color", "#CCC");
                setTimeout(timeCount, 1000);
            } else {
                btn.val("重新发送");
                // 重新设置剩余等待时间
                timeLeft = totalTime;
                btn.removeAttr("disabled");
                btn.css("background-color", "#DF3635")
            }
        }
        btn.bind("click",
        function() {
            // 请求发送验证码到用户手机
            $.get("http://localhost:8088/checkcode/sms/create?phone=" + phone.val(),
            function(data) {

            });
            timeCount();
        })
    });
    var REGISTER = {
    param: {
        //单点登录系统的url
        surl: ""
    },
    inputcheck: function() {
        //不能为空检查
        if ($("#phone").val() === "") {
            alert("手机号不能为空");
            $("#phone").focus();
            return false;
        }
        if ($("#checkcode").val() === "") {
            alert("验证码不能为空");
            $("#checkcode").focus();
            return false;
        }
        return true;
    },
    beforeSubmit: function() {
        // 检查用户输入的验证码是否正确
        $.ajax({
            "url": "http://localhost:8088/checkcode/sms/check?code=" + $("#checkcode").val() + "&phone=" + $("#phone").val(),
            "success": function(data) {
                if (data.status !== 200) {
                    alert(data.msg);
                    return false;
                } else {
                    //检查用户是否已经被占用
                    $.ajax({
                        "url": REGISTER.param.surl + "/user/check/" + escape($("#regName").val()) + "/1?r=" + Math.random(),
                        "success": function(data) {
                            if (data.data) {
                                //检查手机号是否存在
                                $.ajax({
                                    "url": REGISTER.param.surl + "/user/check/" + $("#phone").val() + "/2?r=" + Math.random(),
                                    "success": function(data) {
                                        if (data.data) {
                                            REGISTER.doSubmit();
                                        } else {
                                            alert("此手机号已经被注册！");
                                            $("#phone").select();
                                        }
                                    }
                                });
                            } else {
                                alert("此用户名已经被占用，请选择其他用户名");
                                $("#regName").select();
                            }
                        }
                    });
                }
            },
            "type": "GET",
            "datatype": "json"
        });

    },
    doSubmit: function() {
        $.post("/user/register", $("#personRegForm").serialize(),
        function(data) {
            if (data.status === 200) {
                alert('用户注册成功，请登录！');
                REGISTER.login();
            } else {
                alert("注册失败！");
            }
        });
    },
    login: function() {
        location.href = "/page/login";
        return false;
    },
    reg: function() {
        if (this.inputcheck()) {
            this.beforeSubmit();
        }
    }
};
</script>
```

下面这行代码向后台发送 GET 请求，需要将手机号作为参数传给后台：

```
$.get("http://localhost:8088/checkcode/sms/create?phone=" + phone.val()
```

检查用户输入的验证码是否正确：

```
"url": "http://localhost:8088/checkcode/sms/check?code=" + $("#checkcode").val() + "&phone=" + $("#phone").val()
```

## 后台代码

### Controller 层

```
@RequestMapping("/sms/create") 
public @ResponseBody ResultWrapper createSMSCheckCode(@RequestParam String phone) {
    try {
        return checkCodeService.createSMSCheckCode(phone);
    } catch(Exception e) {
        return ResultWrapper.build(500, ExceptionUtil.getStackTrace(e));
    }
}

@RequestMapping("/sms/check") 
public @ResponseBody ResultWrapper checkSMSCheckCode(@RequestParam String code, @RequestParam String phone) {
    if (code == null || "".equals(code)) {
        return ResultWrapper.build(400, "验证码不能为空");
    }
    if (phone == null || "".equals(phone)) {
        return ResultWrapper.build(400, "手机号不能为空");
    }
    try {
        return checkCodeService.checkSMSCheckCode(code, phone);
    } catch(Exception e) {
        return ResultWrapper.build(500, ExceptionUtil.getStackTrace(e));
    }
}
```

## Service 层

生成验证码流程：

![mark](http://imgblog.kuranado.com/blog/180617/fLHclAHbJ9.png)

```
/**
  * 调用云片网提供的发送短信验证码服务
  * @param phone 用户输入的手机号
  */
@Override 
public ResultWrapper createSMSCheckCode(String phone) {
    // 生成 6 位数验证码，范围为 [100000, 999999]
    Random random = new Random();
    int code = random.nextInt(900000);
    code += 100000;

    // 将生成的验证码保存到 Redis 缓存中
    Jedis jedis = jedisPool.getResource();
    jedis.auth(REDIS_PASSWORD);
    String phoneSMSCode = REDIS_PHONE_SMS_CODE + ":" + phone;
    jedis.set(phoneSMSCode, String.valueOf(code));
    // 设置验证码过期时间
    jedis.expire(phoneSMSCode, Integer.parseInt(REDIS_PHONE_SMS_CODE_EXPIRE));
    jedis.close();

    Map <String, String> params = new HashMap <>();
    params.put("apikey", YUN_PIAN_API_KEY);
    params.put("text", REGISTER_SMS_CONTENT.replace("XXXXXX", String.valueOf(code)));
    params.put("mobile", phone);
    String resultJson = HttpClientUtil.doPost("https://sms.yunpian.com/v2/sms/single_send.json", params);
    Map resultMap = JsonUtil.jsonToPojo(resultJson, Map.class);

    // 短信发送成功
    if ((int) resultMap.get("code") == 0) {
        return ResultWrapper.ok();
    } else {
        return ResultWrapper.build(400, "短信发送失败");
    }
}
```

- 代码中用到的常量都放在 resources.properties 配置文件中，Service 中通过类似 `$Value("${CONSTANT_NAME}")` 形式加载常量，resources.properties 文件中与本文相关的几个常量定义如下：

```
# 云片网 API_KEY
YUN_PIAN_API_KEY=7f8d2c78217ff9a6b65723afe0a8368c
# 注册短信验证码内容
REGISTER_SMS_CONTENT=【KURANADO商城】感谢您注册KURANADO商城，您的注册验证码是:XXXXXX，5分钟内有效，如非本人操作，请忽略此短信
# Redis 中保存的短信验证码 key
REDIS_PHONE_SMS_CODE=REDIS_PHONE_SMS_CODE
# Redis 中保存的短信验证码 key 的过期时间为 300 s（即验证码 5 分钟内有效）
REDIS_PHONE_SMS_CODE_EXPIRE=300
```

其中短信验证的内容正是我们预先定义好的模板

在调用云片网接口前需先阅读云片网 API 文档：
[使用场景](https://www.yunpian.com/doc/zh_CN/scene/smsverify.html)
[Java 调用示例](https://www.yunpian.com/doc/zh_CN/introduction/demos/java.html)

将接口需要的必要数据封装到 Map 中，通过 Apache 的 HttpClient 向云片网短信接口发送跨域请求即可：

下图是我收到的验证码：

![mark](http://imgblog.kuranado.com/blog/180617/mLHjifBgKF.png)

了解了如何发送验证码之后，检查验证码是否正确的逻辑就显得非常简单了，首先检查验证码是否过期，未过期再检测是否正确：

```
/**
  * 检查验证码是否正确
  * @param code
  * @return
  */
@Override 
public ResultWrapper checkSMSCheckCode(String code, String phone) {
    String phoneSMSCode = REDIS_PHONE_SMS_CODE + ":" + phone;
    // 从 Redis 缓存中取出验证码
    Jedis jedis = jedisPool.getResource();
    jedis.auth(REDIS_PASSWORD);
    String smsCode = jedis.get(phoneSMSCode);
    jedis.close();
    // 验证码已过期
    if (StringUtils.isBlank(smsCode)) {
        return ResultWrapper.build(400, "验证码已失效");
    }
    if (smsCode.equals(code)) {
        return ResultWrapper.ok();
    }
    return ResultWrapper.build(400, "验证码错误");
}
```

## 总结

- 要想成功接入一项服务，必须要熟读官方提供的 API 文档，尤其是请求参数和返回值说明
- 除了短信验证码外，还可以调用语音验证码，是不是更高大上一点